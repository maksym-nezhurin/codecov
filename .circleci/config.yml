# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  install-dependencies-build-test:
    docker:
      - image: cimg/node:14.17.0
    # Add steps to the job
    # See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
      - checkout
      - run:
          command: |
            curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 1.22.5 && export PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"
            yarn --frozen-lockfile
          name: Install Dependencies
      - save_cache:
          key: v1-dependency-cache-{{ checksum "yarn.lock" }}
          paths:
            - node_modules/
      - run:
          command: mkdir -p test-results/jest
          name: Create test summary dir
      - run:
          command: yarn build && yarn test:ci
          environment:
            JEST_JUNIT_OUTPUT_DIR: test-results/jest
          name: Run tests
      - run:
          command: |
            family=$(uname -s | tr '[:upper:]' '[:lower:]')
            os="windows"
            [[ $family == "darwin" ]] && os="macos"
            [[ $family == "linux" ]] && os="linux"
            echo "Detected ${os}"
            echo "export os=${os}" >> $BASH_ENV

            filename="codecov"
            [[ $os == "windows" ]] && filename+=".exe"
            echo "export filename=${filename}" >> $BASH_ENV
            [[ $os == "macos" ]] && brew install gpg
            curl -Os "https://uploader.codecov.io/latest/${os}/${filename}"
          name: Download Codecov Uploader
          when: always
      - run:
          command: |
            curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --import # One-time step
            curl -Os "https://uploader.codecov.io/latest/${os}/${filename}.SHA256SUM"
            curl -Os "https://uploader.codecov.io/latest/${os}/${filename}.SHA256SUM.sig"
            gpg --verify $filename.SHA256SUM.sig $filename.SHA256SUM
            shasum -a 256 -c $filename.SHA256SUM || sha256sum -c $filename.SHA256SUM
          name: Validate Codecov Uploader
      - run:
          command: |
            chmod +x $filename
            args=()
            [[ -n "" ]] && args+=( "-f " )
            [[ -n "" ]] && args+=( "" )
            curl -H "Accept: application/json" "https://uploader.codecov.io/${os}/latest" | grep -o '\"version\":\"v[0-9\.\_]\+\"' | head -1
            ./$filename \
                -Q "codecov-circleci-orb-3.1.0" \
                -t "${CODECOV_TOKEN}" \
                -n "${CIRCLE_BUILD_NUM}" \
                -F "" \
                ${args[@]}
          name: Upload Coverage Results
      - run:
          name: "Current status"
          command: "echo Process has finished"

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build-workflow:
    jobs:
      - install-dependencies-build-test
